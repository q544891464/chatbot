<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="theme-color" content="#f3f4f6" />
    <title>AI营销助手</title>
    <link rel="icon" href="./static/AIlogo.png" />
    <link rel="apple-touch-icon" href="./static/AIlogo.png" />
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <div class="app" id="app">
      <header class="topbar">
        <div class="topbar__side"></div>

        <div class="topbar__center">
          <div class="topbar__logo" aria-hidden="true">
            <img src="./static/AIlogo.png" alt="AI营销助手" />
          </div>
          <div class="topbar__title">
            <div class="topbar__name">AI营销助手</div>
            <div class="topbar__sub" id="connHint">未配置平台</div>
          </div>
        </div>

        <div class="topbar__actions">
          <button class="iconbtn iconbtn--icon" id="chatListBtn" type="button" title="对话列表" aria-label="对话列表">
            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
              <path
                fill="currentColor"
                d="M6 5h12a1 1 0 1 1 0 2H6a1 1 0 1 1 0-2Zm0 6h12a1 1 0 1 1 0 2H6a1 1 0 1 1 0-2Zm0 6h12a1 1 0 1 1 0 2H6a1 1 0 1 1 0-2Z"
              />
            </svg>
          </button>
          <button class="iconbtn iconbtn--icon" id="newChatBtn" type="button" title="新对话" aria-label="新对话">
            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
              <path
                fill="currentColor"
                d="M12 5a1 1 0 0 1 1 1v5h5a1 1 0 1 1 0 2h-5v5a1 1 0 1 1-2 0v-5H6a1 1 0 1 1 0-2h5V6a1 1 0 0 1 1-1Z"
              />
            </svg>
          </button>
          <button class="iconbtn iconbtn--icon" id="settingsBtn" type="button" title="设置" aria-label="设置">
            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
              <path
                fill="currentColor"
                d="M19.14 12.94c.04-.31.06-.63.06-.94s-.02-.63-.06-.94l2.03-1.58a.5.5 0 0 0 .12-.64l-1.92-3.32a.5.5 0 0 0-.6-.22l-2.39.96a7.1 7.1 0 0 0-1.63-.94l-.36-2.54A.5.5 0 0 0 13.9 1h-3.8a.5.5 0 0 0-.49.42l-.36 2.54c-.58.23-1.13.54-1.63.94l-2.39-.96a.5.5 0 0 0-.6.22L2.71 7.08a.5.5 0 0 0 .12.64l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94L2.83 14.52a.5.5 0 0 0-.12.64l1.92 3.32c.13.22.39.31.6.22l2.39-.96c.5.4 1.05.71 1.63.94l.36 2.54c.04.24.25.42.49.42h3.8c.24 0 .45-.18.49-.42l.36-2.54c.58-.23 1.13-.54 1.63-.94l2.39.96c.22.09.47 0 .6-.22l1.92-3.32a.5.5 0 0 0-.12-.64l-2.03-1.58ZM12 15.5A3.5 3.5 0 1 1 12 8a3.5 3.5 0 0 1 0 7.5Z"
              />
            </svg>
          </button>
        </div>
      </header>

      <main class="messages" id="messages" role="log" aria-live="polite" aria-relevant="additions text"></main>

      <button class="fab" id="scrollBtn" type="button" aria-label="回到最新" title="回到最新" hidden>
        <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
          <path fill="currentColor" d="M12 4a1 1 0 0 1 1 1v11.6l4.3-4.3a1 1 0 1 1 1.4 1.4l-6 6a1 1 0 0 1-1.4 0l-6-6a1 1 0 1 1 1.4-1.4L11 16.6V5a1 1 0 0 1 1-1Z" />
        </svg>
      </button>

      <footer class="composer">
        <div class="composer__box">
          <textarea
            id="input"
            class="composer__input"
            rows="1"
            placeholder="询问任何问题"
            autocomplete="off"
            autocapitalize="sentences"
            spellcheck="false"
          ></textarea>
          <button class="composer__send" id="sendBtn" type="button" aria-label="发送" title="发送">
            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
              <path fill="currentColor" d="M3.4 20.6a1 1 0 0 1-.96-1.3l2.2-6.1a1 1 0 0 1 .9-.65h6.7a1 1 0 1 1 0 2H6.15l-1.4 3.9 14.3-6.4-14.3-6.4 1.4 3.9h6.05a1 1 0 1 1 0 2H5.54a1 1 0 0 1-.94-.65l-2.2-6.1a1 1 0 0 1 1.36-1.26l18 8a1 1 0 0 1 0 1.82l-18 8a1 1 0 0 1-.36.07Z" />
            </svg>
          </button>
        </div>
        <div class="composer__meta">
          <button class="linkbtn" id="stopBtn" type="button" hidden>停止生成</button>
          <div class="composer__tips" id="tips"></div>
        </div>
      </footer>
    </div>

    <div class="modal" id="chatListModal" aria-hidden="true">
      <div class="modal__backdrop" id="chatListBackdrop"></div>
      <div class="modal__sheet modal__sheet--list" role="dialog" aria-modal="true" aria-labelledby="chatListTitle">
        <div class="modal__header">
          <div class="modal__title" id="chatListTitle">对话列表</div>
          <div class="modal__header-actions">
            <button class="btn ghost" id="newChatFromListBtn" type="button">新建对话</button>
            <button class="iconbtn" id="closeChatListBtn" type="button">关闭</button>
          </div>
        </div>
        <div class="chatlist" id="chatList"></div>
      </div>
    </div>

    <div class="modal" id="settingsModal" aria-hidden="true">
      <div class="modal__backdrop" id="settingsBackdrop"></div>
      <div class="modal__sheet" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
        <div class="modal__header">
          <div class="modal__title" id="settingsTitle">ChatbotAgent 设置</div>
          <button class="iconbtn" id="closeSettingsBtn" type="button">关闭</button>
        </div>

        <form class="form" id="settingsForm">
          <label class="field">
            <div class="field__label">对话平台</div>
            <select class="field__input" id="platform">
              <option value="agent">ChatbotAgent</option>
            </select>
            <div class="field__hint">当前仅支持 ChatbotAgent</div>
          </label>

          <div class="field">
            <div class="field__label">已获取用户信息（测试）</div>
            <div class="user-info">
              <div class="user-info__row">
                <span class="user-info__key">姓名</span>
                <span class="user-info__val" id="userInfoName">-</span>
              </div>
              <div class="user-info__row">
                <span class="user-info__key">手机号</span>
                <span class="user-info__val" id="userInfoPhone">-</span>
              </div>
              <div class="user-info__row">
                <span class="user-info__key">组织</span>
                <span class="user-info__val" id="userInfoOrg">-</span>
              </div>
            </div>
            <div class="field__hint">从平台 SDK 获取，未获取时显示默认值。</div>
          </div>

          <div class="field">
            <div class="field__label">认证测试</div>
            <div class="auth-box">
              <div class="auth-box__row">
                <span class="auth-box__key">授权码</span>
                <span class="auth-box__val" id="authCodeValue">-</span>
              </div>
              <div class="auth-box__row">
                <span class="auth-box__key">State</span>
                <span class="auth-box__val" id="authStateValue">-</span>
              </div>
              <div class="auth-box__row">
                <span class="auth-box__key">Access Token</span>
                <span class="auth-box__val" id="authAccessTokenValue">-</span>
              </div>
              <div class="auth-box__row">
                <span class="auth-box__key">Refresh Token</span>
                <span class="auth-box__val" id="authRefreshTokenValue">-</span>
              </div>
            </div>
            <div class="auth-actions">
              <button class="btn" type="button" id="authStartBtn">获取授权码</button>
            </div>
            <div class="field__hint">点击后跳转到认证服务器，返回后会展示 code。</div>
          </div>

          <label class="field">
            <div class="field__label">API Base URL</div>
            <input class="field__input" id="baseUrl" type="text" placeholder="/api" />
            <div class="field__hint">使用后端代理：填 <code>/api</code> 或 <code>http://localhost:8787/api</code>（推荐）</div>
          </label>

          <label class="field" id="apiKeyField" style="display: none;">
            <div class="field__label">API Key</div>
            <input class="field__input" id="apiKey" type="password" placeholder="app-xxxxxxxxxxxxxxxx" />
            <div class="field__hint">已由后端配置，无需填写。</div>
          </label>

          <div class="row">
            <label class="field">
              <div class="field__label">User ID</div>
              <input class="field__input" id="userId" type="text" placeholder="任意字符串" />
              <div class="field__hint">用于区分用户，会保存在本地。</div>
            </label>
            <label class="field" id="responseModeField" style="display: none;">
              <div class="field__label">响应模式</div>
              <select class="field__input" id="responseMode">
                <option value="streaming">streaming（推荐）</option>
                <option value="blocking">blocking</option>
              </select>
              <div class="field__hint">已固定为 streaming</div>
            </label>
          </div>

          <div class="row">
            <button class="btn" id="saveBtn" type="submit">保存</button>
            <button class="btn ghost" id="resetConversationBtn" type="button">重置 conversation</button>
            <button class="btn danger" id="clearChatBtn" type="button">清空聊天</button>
          </div>

          <div class="field__hint">
            如果你打开的是 file:// 方式，部分浏览器会拦截请求；建议用本地静态服务（如 VS Code Live Server）。
          </div>
        </form>
      </div>
    </div>

    <div class="modal" id="feedbackModal" aria-hidden="true">
      <div class="modal__backdrop" id="feedbackBackdrop"></div>
      <div class="modal__sheet modal__sheet--feedback" role="dialog" aria-modal="true" aria-labelledby="feedbackTitle">
        <div class="modal__header">
          <div class="modal__title" id="feedbackTitle">请填写点踩原因</div>
          <button class="iconbtn" id="feedbackCloseBtn" type="button">关闭</button>
        </div>
        <div class="form feedback-form">
          <label class="field">
            <div class="field__label">原因</div>
            <textarea
              class="field__input field__textarea"
              id="feedbackInput"
              rows="4"
              placeholder="例如：回答不准确、需要更详细的信息"
              maxlength="200"
            ></textarea>
            <div class="field__hint" id="feedbackHint">请简要说明原因，便于改进。</div>
          </label>
          <div class="feedback-actions">
            <button class="btn ghost" id="feedbackCancelBtn" type="button">取消</button>
            <button class="btn" id="feedbackSubmitBtn" type="button">提交</button>
          </div>
        </div>
      </div>
    </div>

    <div class="lightbox" id="imageViewer" aria-hidden="true">
      <div class="lightbox__backdrop" id="imageViewerBackdrop"></div>
      <div class="lightbox__content" id="imageViewerContent" role="dialog" aria-modal="true" aria-label="图片预览">
        <img id="imageViewerImg" alt="图片预览" />
      </div>
    </div>

    <script type="module" src="./app.js"></script>
  </body>
</html>
